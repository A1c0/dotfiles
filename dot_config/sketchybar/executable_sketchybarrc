#!/usr/bin/env nu
let PLUGIN_DIR = $"($env.CONFIG_DIR)/plugins"

use ./utils/color.nu;

# Bar
sketchybar --bar position=top height=35 blur_radius=0 color=0x00000000

# Defaults
(sketchybar --default padding_left=0
                      padding_right=0
                      icon.font="Hack Nerd Font:Bold:15.0"
                      label.font="JetBrainsMono Nerd Font Mono:Regular:14.0"
                      icon.color=(color mocha text)
                      label.color=(color mocha text)
                      icon.padding_left=6
                      icon.padding_right=2
                      label.padding_left=2
                      label.padding_right=6)

# Spaces
sketchybar --add event aerospace_workspace_change
sketchybar --add event aerospace_monitor_change
sketchybar --add event aerospace_mode_change

let space_icon_default = [
   "icon.font=JetBrainsMono Nerd Font Mono:Bold:15.0",
   "label.font=sketchybar-app-font:Regular:16.0",
   background.corner_radius=5,
   background.height=25,
   blur_radius=50,
   padding_left=5,
   padding_right=5,
   icon.padding_left=4,
   icon.padding_right=4,
   label.padding_left=4,
   label.padding_right=4,
]

let sketchybar_options = aerospace list-workspaces --all | lines | each {|workspace|
  let sid = $"space.($workspace)";
  [
    --add item $sid left,
    --set $sid drawing=false,
               icon=($workspace),
               $"click_script=aerospace workspace ($workspace)",
               ...$space_icon_default
  ]
} | flatten;

sketchybar ...$sketchybar_options;

let visible_workspace_option = aerospace list-monitors --json
  | from json
  | get monitor-id
  | each {|display|
    [
      --add item $"focused_space.($display).label" left
      --set $"focused_space.($display).label" "icon.font=JetBrainsMono Nerd Font Mono:Bold:15.0"
                                              label.drawing=false
                                              display=($display)
                                              padding_right=4
      --add item $"focused_space.($display).focused_app" left
      --set $"focused_space.($display).focused_app" "label.font=sketchybar-app-font:Regular:16.0"
                                               label.color=(color mocha mauve)
                                               icon.drawing=false
                                               padding_left=0
                                               padding_right=2
                                               display=($display)
      --add item $"focused_space.($display).unfocused_apps" left
      --set $"focused_space.($display).unfocused_apps" "label.font=sketchybar-app-font:Regular:16.0"
                                               label.color=(color mocha text)
                                               icon.drawing=false
                                               padding_left=0
                                               padding_right=2
                                               display=($display)
      --add bracket $"focused_space.($display).panel" $"/focused_space.($display).*/"
      --set         $"focused_space.($display).panel" background.color=(color mocha base --alpha 0.9)
                                                      background.corner_radius=5
                                                      background.height=25
                                                      blur_radius=50
                                                      display=($display)
    ]
  }

sketchybar ...($visible_workspace_option | flatten)

let space_subcriber = 'space_subcriber'


(sketchybar --add item $space_subcriber left
            --subscribe $space_subcriber aerospace_workspace_change
            --subscribe $space_subcriber aerospace_monitor_change
            --subscribe $space_subcriber front_app_switched
            --subscribe $space_subcriber space_windows_change
            --set $space_subcriber drawing=false
                                   script=($PLUGIN_DIR)/space.nu)


(sketchybar --add item aerospace_mode left
            --subscribe aerospace_mode aerospace_mode_change
            --set aerospace_mode background.color=(color mocha base --alpha 0.8)
                                 background.corner_radius=15
                                 background.height=20
                                 background.border_color=(color mocha mauve)
                                 background.border_width=2
                                 background.padding_left=5
                                 background.padding_right=5
                                 background.height=22
                                 icon.drawing=false
                                 label.font="JetBrainsMono Nerd Font Mono:Bold:13.0"
                                 label.color=(color mocha mauve)
                                 label.align=center
                                 label.padding_left=7
                                 label.padding_right=7
                                 blur_radius=50
                                 script=($PLUGIN_DIR)/space_mode.nu
                                 display=1)

(sketchybar --add item keyboard_switcher left
            --subscribe keyboard_switcher front_app_switched
            --set keyboard_switcher drawing=false
                                    script=($PLUGIN_DIR)/keyboard_switcher.nu)

# Right items
(sketchybar --add item clock right
            --set clock update_freq=1
                        script=($PLUGIN_DIR)/clock.nu
                        icon=
                        label.padding_right=10
                        icon.padding_left=10
            --add item battery right
            --subscribe battery power_source_change
            --set battery
                  update_freq=1
                  click_script="open -a AlDente"
                  script=($PLUGIN_DIR)/battery.nu
            --add item no_internet right
            --set no_internet
                  label.drawing=false
                  icon=󰤭
                  icon.padding_right=6
                  icon.color=(color mocha overlay2)
                  update_freq=10
                  script=($PLUGIN_DIR)/internet.nu

            --add bracket sys_panel clock battery no_internet
            --set         sys_panel background.color=(color mocha base --alpha 0.6)
                                    background.corner_radius=10
                                    background.height=27
                                    blur_radius=50

            --add item spacer_1 right
            --set spacer_1
                  padding_left=0
                  padding_right=5
                  label.drawing=false)

let GITHUB_ICON_FONT = "Hack Nerd Font:Regular:14.0"

(sketchybar --add item github_release right
            --set github_release icon=
                                 icon.font=($GITHUB_ICON_FONT)
                                 icon.color=(color mocha overlay2)
                                 drawing=false
            --add item github_issue_closed right
            --set github_issue_closed icon=
                                      icon.font=($GITHUB_ICON_FONT)
                                      icon.color=(color mocha mauve)
                                      drawing=false
            --add item github_issue_open right
            --set github_issue_open icon=
                                    icon.font=($GITHUB_ICON_FONT)
                                    icon.color=(color mocha green)
                                    drawing=false
            --add item github_pr_closed right
            --set github_pr_closed icon=
                                   icon.font=($GITHUB_ICON_FONT)
                                   icon.color=(color mocha red)
                                   drawing=false
            --add item github_pr_merged right
            --set github_pr_merged icon=
                                  icon.font=($GITHUB_ICON_FONT)
                                  icon.color=(color mocha mauve)
                                  drawing=false
            --add item github_pr_open right
            --set github_pr_open icon=
                                 icon.font=($GITHUB_ICON_FONT)
                                 icon.color=(color mocha green)
                                 drawing=false
            --add item github_icon right
            --set github_icon icon=
                              icon.font="Hack Nerd Font:Regular:21.0"
                              label.drawing=false
                              icon.padding_left=6
                              icon.padding_right=6
                              click_script="open https://github.com/notifications"
                              update_freq=30
                              script=($PLUGIN_DIR)/github.nu
            --add bracket github_panel /github.*/
            --set         github_panel background.color=(color mocha base --alpha 0.6)
                                       background.corner_radius=10
                                       background.height=25
                                       blur_radius=50)

# Reminders
if ('~/.cache/reminder.nuon' | path exists) {
  open ~/.cache/reminder.nuon
  | where done_date > ( date now )
  | collect
  | save -f ~/.cache/reminder.nuon
  sketchybar --add event reminder_db_change;

  # pueue group add watcher -p 1 | ignore
  # pueue add --group watcher -- "nu -c 'watch ~/.cache/reminder.nuon {sketchybar --trigger reminder_db_change }'"

  (sketchybar --add item reminder_updater left
              --subscribe reminder_updater reminder_db_change
              --set reminder_updater drawing=false
                                     script=($PLUGIN_DIR)/reminder_updater.nu)
}

# sketchybar --hotload true
##### Force all scripts to run the first time (never do this in a script) #####
sketchybar --update

